# NVIDIA CUDA 13.0 runtime (Ubuntu 22.04, Python 3.10)
FROM nvidia/cuda:13.0.0-runtime-ubuntu22.04

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# System deps
RUN apt-get update && apt-get install -y \
    python3-pip python3-dev gcc \
    libgl1 libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Pip
RUN pip3 install --upgrade pip

# Dependencies (shared requirements.txt)
COPY requirements.txt .

# Torch/TV with CUDA 13.0 wheels
RUN pip3 install torch==2.3.0+cu130 torchvision==0.18.0+cu130 \
    --extra-index-url https://download.pytorch.org/whl/cu130

# Rest of deps
RUN pip3 install -r requirements.txt

# App
COPY . .

# Make entry flexible per service via envs
ARG PORT=8000
ENV PORT=${PORT}
ARG APP_MODULE="main:app"
ENV APP_MODULE=${APP_MODULE}

EXPOSE ${PORT}

# Start
CMD sh -c "uvicorn ${APP_MODULE} --host 0.0.0.0 --port ${PORT}"

